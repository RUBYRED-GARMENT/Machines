<!DOCTYPE html>
<html lang="en" id="htmlPage" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RUBYRED | Assets Management Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" href="pic/logooo.png">
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --primary: #d80f0f;
            --text: #f1f5f9; --muted: #94a3b8; --border: #334155;
            --green: #16a34a; --red: #dc2626; --orange: #f59e0b; --whatsapp: #25d366;
            --singer: #3b82f6; --over: #a855f7; --orlay: #ec4899;
        }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; transition: 0.3s; }
        .container { max-width: 1200px; margin: auto; }
        .top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .brand { font-weight: 800; font-size: 1.5rem; color:white; letter-spacing: 1px; }
        
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .stat-box { background: var(--card); padding: 12px; border-radius: 12px; border: 1px solid var(--border); text-align: center; cursor: pointer; transition: 0.2s; }
        .stat-box h3 { margin: 0; font-size: 1.2rem; }
        .stat-box p { margin: 2px 0 0; font-size: 0.75rem; font-weight: 600; }
        .active-filter { border: 2px solid white !important; background: rgba(255,255,255,0.15); box-shadow: 0 0 10px rgba(255,255,255,0.1); }

        .type-singer { border-bottom: 4px solid var(--singer); }
        .type-over { border-bottom: 4px solid var(--over); }
        .type-orlay { border-bottom: 4px solid var(--orlay); }

        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        select, input { background: var(--card); color: var(--text); border: 1px solid var(--border); padding: 10px; border-radius: 10px; font-family: 'Cairo'; outline: none; }
        
        .card-urgent { border: 2px solid var(--red) !important; animation: pulseGlow 2s infinite ease-in-out; }
        @keyframes pulseGlow { 0% { box-shadow: 0 0 2px rgba(220, 38, 38, 0.4); } 50% { box-shadow: 0 0 15px rgba(220, 38, 38, 0.7); } 100% { box-shadow: 0 0 2px rgba(220, 38, 38, 0.4); } }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .machine-card { background: var(--card); border-radius: 15px; padding: 15px; border: 1px solid var(--border); transition: 0.3s; cursor: pointer; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        
        .card-body { display: none; margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--border); }
        .machine-card.expanded .card-body { display: block; }
        
        .days-badge { font-size: 0.7rem; padding: 3px 8px; border-radius: 5px; font-weight: bold; margin-top: 5px; display: inline-block; }
        .days-urgent { background: var(--red); color: white; }
        .days-soon { background: var(--orange); color: white; }
        .days-safe { background: var(--green); color: white; }

        .status-badge { font-size: 0.65rem; padding: 3px 8px; border-radius: 15px; font-weight: 700; text-transform: uppercase; }
        .bg-active { background: rgba(22, 163, 74, 0.2); color: var(--green); }
        .bg-repair { background: rgba(220, 38, 38, 0.2); color: var(--red); }
        
        .whatsapp-btn { margin-top: 15px; background: var(--whatsapp); color: white; border: none; padding: 10px; border-radius: 10px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; width: 100%; font-family: 'Cairo'; }
        .detail-item { display: flex; justify-content: space-between; font-size: 0.8rem; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .detail-label { color: var(--muted); }
            .logo img {
      height: 55px;
      width: 55px;
      position: relative;
      left: 735px;
        top: 20px;

      /* ===== FIX: PURE SELF ROTATION ===== */
      animation: spin 4s linear infinite;
      transform-origin: center center !important;
      display: block;
    }
        @keyframes spin {
      from { transform: rotate(0deg); }
      to   { transform: rotate(360deg); }
    }


     @media (max-width: 768px) {
     .logo img {
        transform-origin: center center !important;
         display:none;
      }
      .logo {
        position: fixed;
        left: 55%;
        top: 20px;
        transform: translateX(-50%);
        display:none;

      }
      .logo img {
        height: 50px;
        width: 50px;
        position: fixed;
        left: 0;
        top: 0;
        transform: translateX(-50%);
          display:none;
      }
    }

    </style>
</head>
<body>

<div class="container">
    <header class="top-nav">
        <div class="brand">RUBY<span style="color:red">RED</span> MACHINES</div>
 <div class="logo">
        <img src="pic/logooo.png" alt="rubyred" />
      </div>        <select id="langSelect" onchange="changeLang(this.value)" style="cursor: pointer">
            <option value="en">English</option>
            <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
            <option value="tr">T√ºrk√ße</option>
        </select>
    </header>

    <div class="stats-container" id="statusStats"></div>
    <div class="stats-container" id="typeStats"></div>

    <div class="controls">
        <input type="text" id="searchInput" style="flex:2" placeholder="Search..." onkeyup="filterData()">
        <select id="maintFilter" onchange="filterData()" style="flex:1">
            <option value="all" id="optAll">All</option>
            <option value="urgent" id="optUrgent">Urgent üö®</option>
            <option value="soon" id="optSoon">Soon</option>
            <option value="safe" id="optSafe">Safe</option>
        </select>
    </div>

    <div class="grid" id="machinesGrid"></div>
</div>

<script>
    const SHEET_ID = "1p1JEBOFYfCmys864VVBH-qqzByErjSCxdhu-cqT4Grw";
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;
    const MAINTENANCE_PHONE = "201279552202";

    let allMachines = [];
    let currentLang = 'en';
    let currentStatusFilter = 'all';
    let currentTypeFilter = 'all';

    const dictionary = {
        en: {
            total: "Total", active: "Active", repair: "Repair", singer: "Singer", over: "Over", orlay: "Orlay",
            search: "Search code...", btnReport: "Send Maintenance Report",
            daysLeft: "{n} Days left", daysLate: "{n} Days late", today: "Today",
            optAll: "Maintenance: All", optUrgent: "Urgent üö®", optSoon: "Soon", optSafe: "Safe",
            waTitle: "üö® *MAINTENANCE REQUEST*", waCode: "Code", waLoc: "Location", waModel: "Model", waType: "Type", waLast: "Last Service"
        },
        ar: {
            total: "ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä", active: "ŸäÿπŸÖŸÑ", repair: "ÿ£ÿπÿ∑ÿßŸÑ", singer: "ÿ≥ŸÜÿ¨ÿ±", over: "ÿ£ŸàŸÅÿ±", orlay: "ÿ£Ÿàÿ±ŸÑŸäŸá",
            search: "ÿ®ÿ≠ÿ´ ÿπŸÜ ŸÉŸàÿØ...", btnReport: "ÿ•ÿ±ÿ≥ÿßŸÑ ÿ®ŸÑÿßÿ∫ ÿµŸäÿßŸÜÿ©",
            daysLeft: "ÿ®ÿßŸÇŸä {n} ŸäŸàŸÖ", daysLate: "ŸÖÿ™ÿ£ÿÆÿ± {n} ŸäŸàŸÖ", today: "ŸÖŸàÿπÿØ ÿßŸÑŸäŸàŸÖ",
            optAll: "ÿßŸÑŸÖŸàÿßÿπŸäÿØ: ÿßŸÑŸÉŸÑ", optUrgent: "ÿπÿßÿ¨ŸÑ üö®", optSoon: "ŸÇÿ±Ÿäÿ®ÿßŸã", optSafe: "ÿ¢ŸÖŸÜ",
            waTitle: "üö® *ÿ®ŸÑÿßÿ∫ ÿµŸäÿßŸÜÿ© ŸÅŸÜŸäÿ©*", waCode: "ÿßŸÑŸÉŸàÿØ", waLoc: "ÿßŸÑŸÖŸàŸÇÿπ", waModel: "ÿßŸÑŸÖŸàÿØŸäŸÑ", waType: "ÿßŸÑŸÜŸàÿπ", waLast: "ÿ¢ÿÆÿ± ÿµŸäÿßŸÜÿ©"
        },
        tr: {
            total: "Toplam", active: "Aktif", repair: "Arƒ±za", singer: "Singer", over: "Over", orlay: "Orlay",
            search: "Kod ara...", btnReport: "Bakƒ±m Raporu G√∂nder",
            daysLeft: "{n} g√ºn kaldƒ±", daysLate: "{n} g√ºn gecikti", today: "Bug√ºn",
            optAll: "T√ºm√º", optUrgent: "Acil üö®", optSoon: "Yakƒ±nda", optSafe: "G√ºvenli",
            waTitle: "üö® *BAKIM TALEBƒ∞*", waCode: "Kod", waLoc: "Konum", waModel: "Model", waType: "Tip", waLast: "Son Bakƒ±m"
        }
    };

    async function init() {
        try {
            const response = await fetch(SHEET_URL);
            const text = await response.text();
            const rows = text.split('\n').map(r => r.split('","').map(c => c.replace(/"/g, '')));
            const headers = rows[0].map(h => h.trim());
            allMachines = rows.slice(1).map(row => {
                let obj = {}; headers.forEach((h, i) => obj[h] = row[i]?.trim());
                return obj;
            }).filter(m => m.Code);

            const urlParams = new URLSearchParams(window.location.search);
            const codeFromURL = urlParams.get('code');
            if (codeFromURL) {
                document.getElementById('searchInput').value = codeFromURL;
            }

            updateUI();
        } catch (e) { console.error("Load Error"); }
    }

    function getDaysDiff(dateStr) {
        if (!dateStr || dateStr === '-') return null;
        const d = new Date(dateStr); if (isNaN(d)) return null;
        const today = new Date(); today.setHours(0,0,0,0);
        return Math.ceil((d - today) / (1000 * 60 * 60 * 24));
    }

    function translate(key, n) {
        let text = (dictionary[currentLang] && dictionary[currentLang][key]) ? dictionary[currentLang][key] : key;
        return n !== undefined ? text.replace('{n}', Math.abs(n)) : text;
    }

    function resetAllFilters() {
        currentStatusFilter = 'all';
        currentTypeFilter = 'all';
        document.getElementById('searchInput').value = '';
        document.getElementById('maintFilter').value = 'all';
        updateUI();
    }

    function updateUI() {
        const statsStatus = document.getElementById('statusStats');
        statsStatus.innerHTML = `
            <div class="stat-box ${currentStatusFilter==='all' && currentTypeFilter==='all'?'active-filter':''}" onclick="resetAllFilters()"><h3>${allMachines.length}</h3><p>${translate('total')}</p></div>
            <div class="stat-box ${currentStatusFilter==='active'?'active-filter':''}" style="border-bottom:4px solid var(--green)" onclick="setStatusFilter('active')"><h3>${allMachines.filter(m=>m.Status?.toLowerCase()==='active').length}</h3><p>${translate('active')}</p></div>
            <div class="stat-box ${currentStatusFilter==='repair'?'active-filter':''}" style="border-bottom:4px solid var(--red)" onclick="setStatusFilter('repair')"><h3>${allMachines.filter(m=>m.Status?.toLowerCase()!=='active').length}</h3><p>${translate('repair')}</p></div>
        `;

        const statsType = document.getElementById('typeStats');
        statsType.innerHTML = `
            <div class="stat-box type-singer ${currentTypeFilter==='Singer'?'active-filter':''}" onclick="setTypeFilter('Singer')"><h3>${allMachines.filter(m=>m.Type?.toLowerCase().includes('singer')).length}</h3><p>${translate('singer')}</p></div>
            <div class="stat-box type-over ${currentTypeFilter==='Over'?'active-filter':''}" onclick="setTypeFilter('Over')"><h3>${allMachines.filter(m=>m.Type?.toLowerCase().includes('over')).length}</h3><p>${translate('over')}</p></div>
            <div class="stat-box type-orlay ${currentTypeFilter==='Orlay'?'active-filter':''}" onclick="setTypeFilter('Orlay')"><h3>${allMachines.filter(m=>m.Type?.toLowerCase().includes('orlay')).length}</h3><p>${translate('orlay')}</p></div>
        `;

        document.getElementById('searchInput').placeholder = translate('search');
        document.getElementById('optAll').innerText = translate('optAll');
        document.getElementById('optUrgent').innerText = translate('optUrgent');
        document.getElementById('optSoon').innerText = translate('optSoon');
        document.getElementById('optSafe').innerText = translate('optSafe');

        filterData();
    }

    function filterData() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const maintF = document.getElementById('maintFilter').value;
        const grid = document.getElementById('machinesGrid');
        grid.innerHTML = "";

        allMachines.forEach(m => {
            const mStat = (m.Status || "").toLowerCase();
            const mType = (m.Type || "").toLowerCase();
            const diff = getDaysDiff(m["Next Maintenance"]);
            let mState = (diff !== null && diff <= 7) ? 'urgent' : (diff !== null && diff <= 15 ? 'soon' : 'safe');

            const matchesSearch = m.Code?.toLowerCase().includes(query);
            const matchesStatus = currentStatusFilter === 'all' || (currentStatusFilter === 'active' && mStat === 'active') || (currentStatusFilter === 'repair' && mStat !== 'active');
            const matchesType = currentTypeFilter === 'all' || mType.includes(currentTypeFilter.toLowerCase());
            const matchesMaint = maintF === 'all' || mState === maintF;

            if (matchesSearch && matchesStatus && matchesType && matchesMaint) {
                const card = document.createElement('div');
                card.className = `machine-card ${mState === 'urgent' ? 'card-urgent' : ''}`;
                
                if(query !== '' && m.Code.toLowerCase() === query) card.classList.add('expanded');
                
                card.onclick = (e) => { if(!e.target.closest('button')) card.classList.toggle('expanded'); };
                
                let daysTxt = diff === null ? "" : (diff > 0 ? translate('daysLeft', diff) : (diff < 0 ? translate('daysLate', diff) : translate('today')));
                let daysCls = diff <= 7 ? 'days-urgent' : (diff <= 15 ? 'days-soon' : 'days-safe');
                
                let bodyContent = "";
                Object.entries(m).forEach(([k, v]) => {
                    if(!['Code','Status','Type'].includes(k)) bodyContent += `<div class="detail-item"><span class="detail-label">${k}:</span><span>${v||'-'}</span></div>`;
                });

                card.innerHTML = `
                    <div class="card-header">
                        <div><small style="color:var(--muted)">${m.Type}</small><h4 style="margin:2px 0">${m.Code}</h4></div>
                        <span class="status-badge ${mStat==='active'?'bg-active':'bg-repair'}">${mStat}</span>
                    </div>
                    <div style="font-size:0.85rem; font-weight:600">${m.Model || ''}</div>
                    ${diff!==null ? `<span class="days-badge ${daysCls}">${daysTxt}</span>` : ''}
                    <div class="card-body">
                        ${bodyContent}
                        <button class="whatsapp-btn" onclick="sendWA(${JSON.stringify(m).replace(/"/g, '&quot;')})">
                            <i class="fab fa-whatsapp"></i> ${translate('btnReport')}
                        </button>
                    </div>`;
                grid.appendChild(card);
            }
        });
    }

    function sendWA(machine) {
        const t = dictionary[currentLang];
        const text = `${t.waTitle}%0A%0A` +
                     `üÜî *${t.waCode}:* ${machine.Code}%0A` +
                     `üìç *${t.waLoc}:* ${machine.Location || '-'}%0A` +
                     `üì¶ *${t.waModel}:* ${machine.Model || '-'}%0A` +
                     `‚öôÔ∏è *${t.waType}:* ${machine.Type || '-'}%0A` +
                     `üìÖ *${t.waLast}:* ${machine["Last Maintenance"] || '-'}`;
        window.open(`https://wa.me/${MAINTENANCE_PHONE}?text=${text}`, '_blank');
    }

    function setStatusFilter(s) { currentStatusFilter = s; updateUI(); }
    function setTypeFilter(t) { currentTypeFilter = currentTypeFilter === t ? 'all' : t; updateUI(); }
    function changeLang(l) { currentLang = l; document.getElementById('htmlPage').dir = l === 'ar' ? 'rtl' : 'ltr'; updateUI(); }

    window.onload = init;
</script>
</body>

</html>


